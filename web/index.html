<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta viewport="width=device-width, initial-scale=1">
    <title>disinfo!</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #2c2c2c;
        }

        h1 {
            color: #fff;
            text-align: center;
            font-family: monospace;
            font-size: 2em;
            margin: 0;
            padding: 1em;
        }

        img {
            width: 640px;
            image-rendering: pixelated;
            filter: brightness(1.05) contrast(1.25);
            display: block;
            margin: auto;
            border-radius: 4px;
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <h1>disinfo!</h1>
    <img src='' id='screen'/>
    <div id='controls'>
    </div>
    <script type="module">
        const WS_RETRY_DELAY = 2000;
        const connect = function () {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            let ws = new WebSocket(`${protocol}://${window.location.host}/ws`);

            ws.onmessage = function (event) {
                document.getElementById('screen').src = `data:image/png;base64,${event.data}`;
            };

            ws.onopen = function (event) {
                const interval = setInterval(function () {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send('next');
                    }
                    if (ws.readyState === WebSocket.CLOSED) {
                        clearInterval(interval);
                    }
                }, 100);
            };

            ws.onclose = function () {
                // Handle retries by recreating the connection to websocket.
                console.warn(`Disinfo connection lost. Retrying in ${WS_RETRY_DELAY / 1000}s.`)
                setTimeout(function () {
                    // We generate socket with a timeout to make sure server has time to recover.
                    ws = connect();
                }, WS_RETRY_DELAY);
            }

            ws.onerror = function () {
                ws.close();
            }
        }
        connect();
    </script>
    <script type="module">
        import { h, Component, render } from 'https://esm.sh/preact@10';
        import htm from 'https://esm.sh/htm@3';

        // Initialize htm with Preact
        const html = htm.bind(h);

        function RemoteButton(props) {
            const didClick = () => {
                fetch('/remote', {
                    method: 'POST',
                    body: JSON.stringify({
                        action: props.action,
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                }).then(() => {
                    console.log('Sent button press')
                })
            }
            return html`<button onClick=${didClick}>${props.action}</button>`;
        }


        function App(props) {
            return html`
                <div>
                    <${RemoteButton} action="up" />
                    <${RemoteButton} action="left" />
                    <${RemoteButton} action="right" />
                    <${RemoteButton} action="down" />
                    <${RemoteButton} action="btn_metro" />
                    <${RemoteButton} action="btn_twentytwo" />
                    <${RemoteButton} action="btn_debug" />
                </div>`;
        }

        render(html`<${App} name="World" />`, document.getElementById('controls'));
    </script>
</body>
</html>
